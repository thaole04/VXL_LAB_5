/*
 * fsm.c
 *
 *  Created on: Dec 11, 2023
 *      Author: thao2
 */


#include "main.h"
#include "software_timer.h"
#include "fsm.h"
#include "controlData.h"

int command_mode = 0;
int communiation_mode = 0;
char adc[] = "ADC";
uint8_t nl = 0x0A;
char str[20];
uint32_t ADC_Value = 0;
void command_parser_fsm(){
	switch (command_mode) {
		case 0:
			if (buffer[0] == '!' && buffer[1] == 'R' && buffer[2] == 'S' && buffer[3] == 'T' && buffer[4] == '#') {
				initData();
				setTimer(300);
				command_mode = 1;
			}
			break;
		case 1:
			if (buffer[0] == '!' && buffer[1] == 'O' && buffer[2] == 'K' && buffer[3] == '#'){
				initData();
				timer_flag = 0;
				command_mode = 3;
				communiation_mode = 1;
			}
			break;
		default:
			break;
	}
}
void uart_communiation_fsm(){
	switch (communiation_mode) {
		case 0:
			if (timer_flag == 1){
				timer_flag = 0;
				command_mode = 3;
				communiation_mode = 1;
			}
			break;
		case 1:
			HAL_ADC_Start(&hadc1);
			ADC_Value = HAL_ADC_GetValue(&hadc1);
			HAL_GPIO_TogglePin(LED_RED_GPIO_Port, LED_RED_Pin);
			HAL_UART_Transmit(&huart2, &nl, 1, 100);
			HAL_UART_Transmit(&huart2, adc, 3, 1000);
			HAL_UART_Transmit(&huart2, (void *)str, sprintf(str, "%d\n", ADC_Value), 1000);
			communiation_mode = 0;
			command_mode = 0;
			timer_flag = 0;
			break;
		default:
			break;
	}
}
